---
import type { SiteMeta } from "@/data/siteMeta";
import BaseHead from "@/components/BaseHead";
import Header from "@/components/layout/Header";
import Footer from "@/components/layout/Footer";
import SkipLink from "@/components/SkipLink";
import siteConfig from "@/site-config";
import NowPlaying from "src/components/NowPlaying";
import { ViewTransitions } from 'astro:transitions';
import  SpeedInsights  from "@vercel/speed-insights/astro"

interface Props {
	meta: SiteMeta;
}

const {
	meta: { title, description = siteConfig.description, ogImage, articleDate },
} = Astro.props;
---

<html lang={siteConfig.lang} class="dark">
	<head>
		<BaseHead title={title} description={description} ogImage={ogImage} articleDate={articleDate} />
		<script define:vars={{ siteConfig }}>
			const root = document.documentElement;
			const colorThemeMetaTag = document.querySelector("meta[name='theme-color']");
			// get user preference of dark mode, 1st local storage, 2nd browser
			function getThemePreference() {
        console.log("data", typeof localStorage, localStorage.getItem("theme"))
				if (typeof localStorage !== "undefined" && localStorage.getItem("theme")) {
					return localStorage.getItem("theme");
				}
				return window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
			}


      function watchTheme(){
			  const isDark = getThemePreference() === "dark";
        console.log('watchTheme',isDark);
        // watch document element class attribute and update user preference when it changes.
        const observer = new MutationObserver(() => {
          const rootIsDark = root.classList.contains("dark");
          // set the meta attribute
          colorThemeMetaTag.setAttribute(
            "content",
            siteConfig[rootIsDark ? "themeColorDark" : "themeColorLight"]
          );

        });
        observer.observe(root, { attributeFilter: ["class"] });

        // initailse root class attribute
        root.classList.toggle("dark", isDark);
      }

      document.addEventListener("DOMContentLoaded", watchTheme);
      document.addEventListener("astro:after-swap", watchTheme);
		</script>

		<link rel="webmention" href="https://webmention.io/deloughry.co.uk/webmention" />
		<link rel="pingback" href="https://webmention.io/deloughry.co.uk/xmlrpc" />
    <ViewTransitions />
    <script defer src="https://umami-ss8o8so.loki.m4p.uk/script.js" data-website-id="b5e92cd1-103c-4610-909f-d21ff2988762"></script>
	</head>
	<body>
		<!-- CRT Scanlines Overlay -->
		<div class="crt-overlay" aria-hidden="true"></div>

		<!-- Matrix Rain Background -->
		<canvas id="matrix-canvas" class="matrix-bg" aria-hidden="true"></canvas>

		<SkipLink />
		<Header  transition:name="header"  />
		<main id="main" class="flex-1">
			<NowPlaying client:load transition:name="now-playing" transition:animate={"slide"} transition:persist/>
			<slot />
		</main>
		<Footer />
    <SpeedInsights />

		<!-- Matrix Rain Script -->
		<script>
			function initMatrix() {
				const canvas = document.getElementById('matrix-canvas') as HTMLCanvasElement;
				if (!canvas) return;

				const ctx = canvas.getContext('2d');
				if (!ctx) return;

				// Set canvas size
				function resize() {
					canvas.width = window.innerWidth;
					canvas.height = window.innerHeight;
				}
				resize();
				window.addEventListener('resize', resize);

				// Matrix characters
				const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789@#$%^&*()_+-=[]{}|;:,.<>?~';
				const fontSize = 14;
				const columns = Math.floor(canvas.width / fontSize);
				const drops: number[] = [];

				// Initialize drops
				for (let i = 0; i < columns; i++) {
					drops[i] = Math.random() * -100;
				}

				function draw() {
					// Semi-transparent black for trail effect
					ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
					ctx.fillRect(0, 0, canvas.width, canvas.height);

					// Green text
					ctx.fillStyle = '#00FF87';
					ctx.font = `${fontSize}px 'JetBrains Mono', monospace`;

					for (let i = 0; i < drops.length; i++) {
						const char = chars[Math.floor(Math.random() * chars.length)];
						const x = i * fontSize;
						const y = drops[i] * fontSize;

						ctx.fillText(char, x, y);

						// Reset drop to top with random delay
						if (y > canvas.height && Math.random() > 0.975) {
							drops[i] = 0;
						}
						drops[i]++;
					}
				}

				// Slow animation for subtlety
				setInterval(draw, 100);
			}

			// Initialize on load and after page transitions
			document.addEventListener('DOMContentLoaded', initMatrix);
			document.addEventListener('astro:after-swap', initMatrix);
		</script>
	</body>
</html>
