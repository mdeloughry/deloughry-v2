---
import type { CollectionEntry } from "astro:content";

import BaseLayout from "./Base.astro";
import { getTagSlug, formatTagForDisplay } from "@/utils";

interface Props {
	post: CollectionEntry<"post">;
}

const { post } = Astro.props;
const {
	data: { title, description, ogImage, publishDate },
	slug,
} = post;
const socialImage = ogImage ?? `/og-image/${slug}.png`;
const articleDate = publishDate.toISOString();
const { headings } = await post.render();
---

<script>
	const scrollBtn = document.getElementById("to-top-btn") as HTMLButtonElement;
	const targetHeader = document.getElementById("blog-hero") as HTMLDivElement;

	function callback(entries: IntersectionObserverEntry[]) {
		entries.forEach((entry) => {
			// only show the scroll to top button when the heading is out of view
			scrollBtn.dataset.show = (!entry.isIntersecting).toString();
		});
	}

	scrollBtn.addEventListener("click", () => {
		document.documentElement.scrollTo({ top: 0, behavior: "smooth" });
	});

	const observer = new IntersectionObserver(callback);
	observer.observe(targetHeader);
</script>

<BaseLayout meta={{ title, description, articleDate, ogImage: socialImage }}>
	<article class="blog-post h-entry">
		<header class="blog-post-header" id="blog-hero">
			{ogImage && (
				<div class="blog-post-image">
					<img src={ogImage} alt="" aria-hidden="true" />
					<div class="image-overlay" aria-hidden="true"></div>
				</div>
			)}
			<div class="blog-post-meta">
				<time datetime={articleDate} class="blog-post-date">
					{new Date(publishDate).toLocaleDateString('en-GB', {
						year: 'numeric',
						month: 'long',
						day: 'numeric'
					})}
				</time>
				<h1 class="blog-post-title">{title}</h1>
				{post.data.tags && post.data.tags.length > 0 && (
					<div class="blog-post-tags">
						{post.data.tags.map((tag) => (
							<a href={`/tags/${getTagSlug(tag)}`} class="neon-tag" title={`View posts with tag: ${formatTagForDisplay(tag)}`}>
								{formatTagForDisplay(tag)}
							</a>
						))}
					</div>
				)}
				{description && <p class="blog-post-description">{description}</p>}
			</div>
		</header>

		<div class="blog-post-content">
			<div class="blog-post-body">
				<div
					class="prose prose-lg prose-neon w-full max-w-none prose-headings:font-orbitron prose-headings:uppercase prose-headings:tracking-wider"
				>
					<slot />
				</div>
			</div>

			{headings.length > 0 && (
				<aside class="blog-post-toc">
					<h2 class="toc-title">
						<span class="title-decorator" aria-hidden="true">//</span>
						Contents
					</h2>
					<nav aria-label="Table of contents">
						<ul class="toc-list">
							{
								headings.flatMap(({ slug, text }) => (
									<li class="toc-item">
										<a href={`#${slug}`} aria-label={`Scroll to section: ${text}`}>
											{text}
										</a>
									</li>
								))
							}
						</ul>
					</nav>
				</aside>
			)}
		</div>
	</article>

	<button
		id="to-top-btn"
		class="scroll-to-top"
		aria-label="Back to Top"
		data-show="false"
	>
		<svg
			xmlns="http://www.w3.org/2000/svg"
			aria-hidden="true"
			focusable="false"
			fill="none"
			viewBox="0 0 24 24"
			stroke-width="2"
			stroke="currentColor"
			class="h-6 w-6"
		>
			<path stroke-linecap="round" stroke-linejoin="round" d="M4.5 15.75l7.5-7.5 7.5 7.5"></path>
		</svg>
	</button>

	<style>
		.blog-post {
			max-width: 1000px;
			margin: 0 auto;
			padding: 1.5rem;
			background: rgba(10, 10, 10, 0.9);
			border: 1px solid var(--neon-pink);
			border-radius: 12px;
			box-shadow:
				0 0 10px rgba(255, 107, 157, 0.2),
				inset 0 0 20px rgba(255, 107, 157, 0.05);
			font-family: 'Exo 2', sans-serif;
			line-height: 1.7;
		}

		.blog-post-header {
			text-align: center;
			margin-bottom: 3rem;
			padding-bottom: 2rem;
			position: relative;
		}

		/* Neon bottom border */
		.blog-post-header::after {
			content: '';
			position: absolute;
			bottom: 0;
			left: 0;
			right: 0;
			height: 2px;
			background: linear-gradient(
				90deg,
				transparent,
				var(--neon-pink),
				var(--neon-cyan),
				var(--neon-pink),
				transparent
			);
			box-shadow: 0 0 10px var(--neon-pink);
		}

		.blog-post-image {
			margin: -1.5rem -1.5rem 2rem -1.5rem;
			width: calc(100% + 3rem);
			position: relative;
			overflow: hidden;
			border-top-left-radius: 12px;
			border-top-right-radius: 12px;
		}

		.blog-post-image img {
			width: 100%;
			height: 350px;
			object-fit: cover;
			transition: all 0.4s ease;
			filter: saturate(0.7) brightness(0.9);
		}

		.blog-post-image:hover img {
			filter: saturate(1.1) brightness(1);
		}

		.image-overlay {
			position: absolute;
			inset: 0;
			background: linear-gradient(
				180deg,
				transparent 0%,
				transparent 40%,
				rgba(10, 10, 10, 0.8) 80%,
				rgba(10, 10, 10, 1) 100%
			);
			pointer-events: none;
		}

		/* Only apply image overlay positioning when there's an image */
		.blog-post:has(.blog-post-image) .blog-post-meta {
			z-index: 2;
			margin-top: -150px;
			padding-top: 50px;
		}

		.blog-post-meta {
			position: relative;
		}

		.blog-post-date {
			display: inline-block;
			font-size: 0.85rem;
			color: var(--neon-cyan);
			font-weight: 600;
			margin-bottom: 1rem;
			font-family: 'Orbitron', sans-serif;
			text-transform: uppercase;
			letter-spacing: 2px;
			padding: 0.5rem 1rem;
			background: rgba(0, 217, 255, 0.1);
			border: 1px solid rgba(0, 217, 255, 0.3);
			border-radius: 4px;
		}

		.blog-post-title {
			font-size: 2.5rem;
			font-weight: 700;
			margin-bottom: 1rem;
			color: var(--neon-pink);
			font-family: 'Orbitron', sans-serif;
			text-transform: uppercase;
			letter-spacing: 2px;
			text-shadow:
				0 0 10px rgba(255, 107, 157, 0.5),
				0 0 20px rgba(255, 107, 157, 0.3);
		}

		.blog-post-tags {
			display: flex;
			flex-wrap: wrap;
			justify-content: center;
			gap: 0.5rem;
			margin-bottom: 1rem;
		}

		.blog-post-description {
			font-size: 1.15rem;
			color: var(--theme-quote);
			font-style: italic;
			margin: 0;
			max-width: 600px;
			margin-left: auto;
			margin-right: auto;
		}

		.blog-post-content {
			display: grid;
			grid-template-columns: 1fr 280px;
			gap: 2.5rem;
		}

		.blog-post-body {
			min-width: 0;
		}

		.blog-post-toc {
			position: sticky;
			top: 2rem;
			height: fit-content;
			padding: 1.5rem;
			background: rgba(10, 10, 10, 0.8);
			border: 1px solid var(--neon-cyan);
			border-radius: 8px;
			box-shadow: 0 0 10px rgba(0, 217, 255, 0.2);
		}

		.toc-title {
			font-size: 1rem;
			font-weight: 600;
			margin-bottom: 1rem;
			color: var(--neon-cyan);
			font-family: 'Orbitron', sans-serif;
			text-transform: uppercase;
			letter-spacing: 1px;
		}

		.title-decorator {
			color: var(--neon-pink);
			margin-right: 0.5rem;
		}

		.toc-list {
			list-style: none;
			padding: 0;
			margin: 0;
		}

		.toc-item {
			margin-bottom: 0.25rem;
		}

		.toc-item a {
			display: block;
			padding: 0.5rem 0.75rem;
			color: var(--theme-text);
			text-decoration: none;
			border-radius: 4px;
			transition: all 0.3s ease;
			font-size: 0.85rem;
			font-weight: 500;
			border-left: 2px solid transparent;
		}

		.toc-item a:hover {
			background: rgba(0, 217, 255, 0.1);
			color: var(--neon-cyan);
			border-left-color: var(--neon-cyan);
			text-shadow: 0 0 10px var(--neon-cyan);
		}

		.toc-item a:focus-visible {
			outline: none;
			background: rgba(255, 107, 157, 0.1);
			color: var(--neon-pink);
			border-left-color: var(--neon-pink);
		}

		.scroll-to-top {
			position: fixed;
			bottom: 2rem;
			right: 2rem;
			width: 3rem;
			height: 3rem;
			background: rgba(255, 107, 157, 0.2);
			color: var(--neon-pink);
			border: 2px solid var(--neon-pink);
			border-radius: 8px;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			opacity: 0;
			transform: translateY(100px);
			transition: all 0.3s ease;
			z-index: 100;
		}

		.scroll-to-top[data-show="true"] {
			opacity: 1;
			transform: translateY(0);
		}

		.scroll-to-top:hover {
			background: rgba(255, 107, 157, 0.3);
			box-shadow: 0 0 20px var(--neon-pink);
			transform: scale(1.1);
		}

		.scroll-to-top:focus-visible {
			outline: none;
			border-color: var(--neon-cyan);
			color: var(--neon-cyan);
			box-shadow: 0 0 20px var(--neon-cyan);
		}

		@media (max-width: 1024px) {
			.blog-post-content {
				grid-template-columns: 1fr;
				gap: 2rem;
			}

			.blog-post-toc {
				position: static;
				order: -1;
			}
		}

		@media (max-width: 768px) {
			.blog-post {
				padding: 1rem;
				margin: 0 -0.5rem;
			}

			.blog-post-title {
				font-size: 1.75rem;
			}

			.blog-post-image {
				margin: -1rem -1rem 2rem -1rem;
				width: calc(100% + 2rem);
			}

			.blog-post-image img {
				height: 220px;
			}
		}

		@media (prefers-reduced-motion: reduce) {
			.blog-post-image img {
				transition: none;
			}

			.toc-item a {
				transition: none;
			}

			.scroll-to-top {
				transition: opacity 0.01ms, transform 0.01ms;
			}

			.scroll-to-top:hover {
				transform: none;
			}
		}
	</style>
</BaseLayout>
