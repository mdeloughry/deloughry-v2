---
import type { CollectionEntry } from "astro:content";

import BaseLayout from "./Base.astro";
import { getTagSlug, formatTagForDisplay } from "@/utils";

interface Props {
	post: CollectionEntry<"post">;
}

const { post } = Astro.props;
const {
	data: { title, description, ogImage, publishDate },
	slug,
} = post;
const socialImage = ogImage ?? `/og-image/${slug}.png`;
const articleDate = publishDate.toISOString();
const { headings } = await post.render();
---

<script>
	const scrollBtn = document.getElementById("to-top-btn") as HTMLButtonElement;
	const targetHeader = document.getElementById("blog-hero") as HTMLDivElement;

	function callback(entries: IntersectionObserverEntry[]) {
		entries.forEach((entry) => {
			// only show the scroll to top button when the heading is out of view
			scrollBtn.dataset.show = (!entry.isIntersecting).toString();
		});
	}

	scrollBtn.addEventListener("click", () => {
		document.documentElement.scrollTo({ top: 0, behavior: "smooth" });
	});

	const observer = new IntersectionObserver(callback);
	observer.observe(targetHeader);
</script>

<BaseLayout meta={{ title, description, articleDate, ogImage: socialImage }}>
	<article class="bbs-blog-post h-entry">
		<!-- Post Header -->
		<header id="blog-hero" class="mb-4">
			<div class="bbs-box">
				<div class="px-3 py-1 border-b border-bbs-gray flex items-center justify-between">
					<div class="flex items-center gap-2">
						<span class="text-accent" aria-hidden="true">┌─[</span>
						<span class="text-bbs-cyan font-bold">MESSAGE</span>
						<span class="text-accent" aria-hidden="true">]─</span>
					</div>
					<time datetime={articleDate} class="text-bbs-gray text-xs">
						{new Date(publishDate).toLocaleDateString('en-GB', {
							year: 'numeric',
							month: 'long',
							day: 'numeric'
						})}
					</time>
				</div>

				<div class="p-4">
					{ogImage && (
						<div class="mb-4 border border-bbs-gray overflow-hidden">
							<img
								src={ogImage}
								alt={title}
								class="w-full h-48 sm:h-64 object-cover filter grayscale hover:grayscale-0 transition-all"
							/>
						</div>
					)}

					<h1 class="text-xl sm:text-2xl text-bbs-cyan font-bold mb-3">{title}</h1>

					{post.data.tags && post.data.tags.length > 0 && (
						<div class="flex flex-wrap gap-1 mb-3">
							{post.data.tags.map((tag) => (
								<a
									href={`/tags/${getTagSlug(tag)}`}
									class="bbs-tag text-xs"
									title={`View posts with tag: ${formatTagForDisplay(tag)}`}
								>
									{formatTagForDisplay(tag)}
								</a>
							))}
						</div>
					)}

					{description && (
						<p class="text-sm text-bbs-gray italic border-l-2 border-accent pl-3">
							{description}
						</p>
					)}
				</div>
			</div>
		</header>

		<!-- Content Layout -->
		<div class="flex flex-col lg:flex-row gap-4">
			<!-- Main Content -->
			<div class="flex-1 min-w-0">
				<div class="bbs-box">
					<div class="px-3 py-1 border-b border-bbs-gray flex items-center gap-2">
						<span class="text-accent" aria-hidden="true">┌─[</span>
						<span class="text-bbs-cyan font-bold">CONTENT</span>
						<span class="text-accent" aria-hidden="true">]─</span>
					</div>

					<div class="p-4">
						<div
							class="prose prose-sm prose-cactus w-full max-w-none prose-headings:text-bbs-cyan prose-headings:font-bold prose-a:text-bbs-cyan prose-a:no-underline hover:prose-a:text-accent prose-strong:text-accent prose-code:text-bbs-cyan prose-pre:bg-bbs-dark-gray prose-pre:border prose-pre:border-bbs-gray"
						>
							<slot />
						</div>
					</div>
				</div>
			</div>

			<!-- Table of Contents Sidebar -->
			{headings.length > 0 && (
				<aside class="lg:w-64 lg:flex-shrink-0">
					<div class="bbs-box lg:sticky lg:top-4">
						<div class="px-3 py-1 border-b border-bbs-gray flex items-center gap-2">
							<span class="text-accent" aria-hidden="true">┌─[</span>
							<span class="text-bbs-cyan font-bold text-xs">TOC</span>
							<span class="text-accent" aria-hidden="true">]─</span>
						</div>

						<nav class="p-3" aria-label="Table of contents">
							<ul class="space-y-1 text-xs">
								{headings.map(({ slug, text }, index) => (
									<li>
										<a
											href={`#${slug}`}
											class="bbs-link block py-1 hover:bg-bbs-dark-gray px-2 transition-colors"
											aria-label={`Jump to section: ${text}`}
										>
											<span class="text-bbs-magenta" aria-hidden="true">[{String(index + 1).padStart(2, '0')}]</span>
											<span class="ml-1 line-clamp-1">{text}</span>
										</a>
									</li>
								))}
							</ul>
						</nav>
					</div>
				</aside>
			)}
		</div>

		<!-- Footer Actions -->
		<div class="mt-4">
			<div class="bbs-box">
				<div class="p-3 flex flex-wrap gap-2 justify-center">
					<a href="/posts" class="bbs-button text-xs">
						<span aria-hidden="true">[B]</span> BACK TO POSTS
					</a>
					<a href="/" class="bbs-button text-xs">
						<span aria-hidden="true">[M]</span> MAIN MENU
					</a>
				</div>
			</div>
		</div>
	</article>

	<!-- Scroll to top button -->
	<button
		id="to-top-btn"
		class="scroll-to-top"
		aria-label="Back to Top"
		data-show="false"
	>
		<span class="text-xs font-bold" aria-hidden="true">TOP</span>
	</button>
</BaseLayout>

<style>
	.bbs-blog-post {
		font-family: 'IBM Plex Mono', monospace;
	}

	.line-clamp-1 {
		display: -webkit-box;
		-webkit-line-clamp: 1;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}

	.scroll-to-top {
		position: fixed;
		bottom: 2rem;
		right: 2rem;
		width: 3rem;
		height: 3rem;
		background: var(--theme-bg);
		border: 1px solid var(--theme-accent);
		color: var(--theme-accent);
		cursor: pointer;
		display: flex;
		align-items: center;
		justify-content: center;
		opacity: 0;
		transform: translateY(100px);
		transition: all 0.3s ease;
		z-index: 100;
	}

	.scroll-to-top[data-show="true"] {
		opacity: 1;
		transform: translateY(0);
	}

	.scroll-to-top:hover {
		background: var(--theme-accent);
		color: #000;
	}

	.scroll-to-top:focus-visible {
		outline: 2px solid var(--bbs-cyan);
		outline-offset: 2px;
	}

	/* Prose overrides for BBS style */
	:global(.bbs-blog-post .prose h2),
	:global(.bbs-blog-post .prose h3),
	:global(.bbs-blog-post .prose h4) {
		color: var(--bbs-cyan);
		margin-top: 2rem;
		padding-bottom: 0.5rem;
		border-bottom: 1px solid var(--bbs-gray);
	}

	:global(.bbs-blog-post .prose h2::before),
	:global(.bbs-blog-post .prose h3::before),
	:global(.bbs-blog-post .prose h4::before) {
		content: '## ';
		color: var(--theme-accent);
	}

	:global(.bbs-blog-post .prose blockquote) {
		border-left: 2px solid var(--theme-accent);
		background: var(--bbs-dark-gray);
		padding: 1rem;
		font-style: normal;
	}

	:global(.bbs-blog-post .prose code) {
		background: var(--bbs-dark-gray);
		border: 1px solid var(--bbs-gray);
		padding: 0.125rem 0.25rem;
		border-radius: 0;
	}

	:global(.bbs-blog-post .prose pre) {
		border-radius: 0;
	}

	:global(.bbs-blog-post .prose ul) {
		list-style: none;
		padding-left: 1.5rem;
	}

	:global(.bbs-blog-post .prose ul li) {
		position: relative;
	}

	:global(.bbs-blog-post .prose ul li::before) {
		content: '> ';
		color: var(--bbs-cyan);
		margin-left: -1.5rem;
		position: absolute;
	}

	:global(.bbs-blog-post .prose ol) {
		list-style: none;
		counter-reset: bbs-counter;
		padding-left: 2rem;
	}

	:global(.bbs-blog-post .prose ol li) {
		counter-increment: bbs-counter;
		position: relative;
	}

	:global(.bbs-blog-post .prose ol li::before) {
		content: '[' counter(bbs-counter, decimal-leading-zero) '] ';
		color: var(--bbs-magenta);
		position: absolute;
		left: -2rem;
	}

	@media (prefers-reduced-motion: reduce) {
		.scroll-to-top {
			transition: none;
		}
	}
</style>
