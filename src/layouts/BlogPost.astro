---
import type { CollectionEntry } from "astro:content";

import BaseLayout from "./Base.astro";
import { getTagSlug, formatTagForDisplay } from "@/utils";

interface Props {
	post: CollectionEntry<"post">;
}

const { post } = Astro.props;
const {
	data: { title, description, ogImage, publishDate },
	slug,
} = post;
const socialImage = ogImage ?? `/og-image/${slug}.png`;
const articleDate = publishDate.toISOString();
const { headings } = await post.render();
---

<script>
	const scrollBtn = document.getElementById("to-top-btn") as HTMLButtonElement;
	const targetHeader = document.getElementById("blog-hero") as HTMLDivElement;

	function callback(entries: IntersectionObserverEntry[]) {
		entries.forEach((entry) => {
			// only show the scroll to top button when the heading is out of view
			scrollBtn.dataset.show = (!entry.isIntersecting).toString();
		});
	}

	scrollBtn.addEventListener("click", () => {
		document.documentElement.scrollTo({ top: 0, behavior: "smooth" });
	});

	if (targetHeader) {
		const observer = new IntersectionObserver(callback);
		observer.observe(targetHeader);
	}

	// TOC toggle for mobile
	function setupTocToggle() {
		const tocToggle = document.querySelector(".toc-toggle") as HTMLButtonElement;
		const tocList = document.getElementById("toc-list") as HTMLUListElement;
		const tocAside = document.querySelector(".blog-post-toc") as HTMLElement;

		if (!tocToggle || !tocList) return;

		// Check if we're on mobile
		const isMobile = () => window.matchMedia("(max-width: 1024px)").matches;

		// Set initial state based on screen size
		const setInitialState = () => {
			if (isMobile()) {
				tocToggle.setAttribute("aria-expanded", "false");
				tocAside?.classList.remove("toc-expanded");
			} else {
				tocToggle.setAttribute("aria-expanded", "true");
				tocAside?.classList.add("toc-expanded");
			}
		};

		setInitialState();

		// Handle resize
		window.addEventListener("resize", setInitialState);

		tocToggle.addEventListener("click", () => {
			const isExpanded = tocToggle.getAttribute("aria-expanded") === "true";
			tocToggle.setAttribute("aria-expanded", (!isExpanded).toString());
			tocAside?.classList.toggle("toc-expanded");
		});

		// Close TOC when clicking a link on mobile
		tocList.querySelectorAll("a").forEach((link) => {
			link.addEventListener("click", () => {
				if (isMobile()) {
					tocToggle.setAttribute("aria-expanded", "false");
					tocAside?.classList.remove("toc-expanded");
				}
			});
		});
	}

	setupTocToggle();
</script>

<BaseLayout meta={{ title, description, articleDate, ogImage: socialImage }}>
	<article class="blog-post h-entry">
		<header id="blog-hero" class="blog-post-header">
			{ogImage && (
				<div class="blog-post-image">
					<img src={ogImage} alt={title} />
					<div class="image-scanlines" aria-hidden="true"></div>
				</div>
			)}
			<div class="blog-post-meta">
				<time datetime={articleDate} class="blog-post-date">
					{new Date(publishDate).toLocaleDateString('en-GB', {
						year: 'numeric',
						month: 'short',
						day: 'numeric'
					}).toUpperCase().replace(/ /g, '_')}
				</time>
				<h1 class="blog-post-title glitch-text" data-text={title}>{title}</h1>
				{post.data.tags && post.data.tags.length > 0 && (
					<div class="blog-post-tags">
						{post.data.tags.map((tag) => (
							<a href={`/tags/${getTagSlug(tag)}`} class="brutal-tag" title={`View posts with tag: ${formatTagForDisplay(tag)}`}>
								{formatTagForDisplay(tag)}
							</a>
						))}
					</div>
				)}
				{description && <p class="blog-post-description">{description}</p>}
			</div>
		</header>

		<div class="blog-post-content">
			<div class="blog-post-body">
				<div
					class="prose prose-lg prose-brutalist w-full max-w-none"
				>
					<slot />
				</div>
			</div>

			{headings.length > 0 && (
				<aside class="blog-post-toc">
					<div class="toc-container brutal-card">
						<button class="toc-toggle" aria-expanded="false" aria-controls="toc-list">
							<h2 class="toc-title">
								<span class="text-accent">//</span> TOC_
							</h2>
							<svg class="toc-chevron" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">
								<path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
							</svg>
						</button>
						<ul id="toc-list" class="toc-list">
							{headings.map(({ slug, text }) => (
								<li class="toc-item">
									<a href={`#${slug}`} aria-label={`Scroll to section: ${text}`}>
										<span class="toc-marker">&gt;</span>
										{text}
									</a>
								</li>
							))}
						</ul>
					</div>
				</aside>
			)}
		</div>
	</article>

	<button
		id="to-top-btn"
		class="scroll-to-top"
		aria-label="Back to Top"
		data-show="false"
	>
		<svg
			xmlns="http://www.w3.org/2000/svg"
			aria-hidden="true"
			focusable="false"
			fill="none"
			viewBox="0 0 24 24"
			stroke-width="2"
			stroke="currentColor"
			class="h-6 w-6"
		>
			<path stroke-linecap="square" stroke-linejoin="miter" d="M4.5 15.75l7.5-7.5 7.5 7.5"></path>
		</svg>
	</button>

	<style>
		.blog-post {
			max-width: 1200px;
			margin: 0 auto;
		}

		.blog-post-header {
			margin-bottom: 3rem;
			padding-bottom: 2rem;
			border-bottom: 4px solid var(--theme-accent);
		}

		.blog-post-image {
			position: relative;
			margin-bottom: 2rem;
			border: 4px solid var(--theme-accent);
			overflow: hidden;
		}

		.blog-post-image img {
			width: 100%;
			height: 400px;
			object-fit: cover;
			filter: grayscale(100%) contrast(1.1);
			transition: filter 0.3s ease;
		}

		.blog-post-image:hover img {
			filter: grayscale(0%) contrast(1);
		}

		.image-scanlines {
			position: absolute;
			inset: 0;
			background: repeating-linear-gradient(
				0deg,
				transparent,
				transparent 2px,
				rgba(0, 0, 0, 0.1) 2px,
				rgba(0, 0, 0, 0.1) 4px
			);
			pointer-events: none;
		}

		.blog-post-meta {
			display: flex;
			flex-direction: column;
			gap: 1rem;
		}

		.blog-post-date {
			font-family: 'JetBrains Mono', monospace;
			font-size: 0.875rem;
			color: var(--theme-accent);
			letter-spacing: 0.1em;
		}

		.blog-post-title {
			font-family: 'JetBrains Mono', monospace;
			font-size: clamp(1.75rem, 5vw, 3rem);
			font-weight: 700;
			line-height: 1.2;
			color: var(--theme-text);
			text-transform: uppercase;
			margin: 0;
		}

		.blog-post-tags {
			display: flex;
			flex-wrap: wrap;
			gap: 0.5rem;
		}

		.blog-post-description {
			font-size: 1.1rem;
			color: var(--theme-muted);
			line-height: 1.6;
			margin: 0;
			padding-left: 1rem;
			border-left: 4px solid var(--theme-accent);
		}

		.blog-post-content {
			display: grid;
			grid-template-columns: 1fr 280px;
			gap: 3rem;
		}

		.blog-post-body {
			min-width: 0;
		}

		/* Prose overrides for brutalist style */
		.blog-post-body :global(h1),
		.blog-post-body :global(h2),
		.blog-post-body :global(h3),
		.blog-post-body :global(h4) {
			font-family: 'JetBrains Mono', monospace;
			text-transform: uppercase;
			letter-spacing: 0.05em;
			color: var(--theme-accent);
			margin-top: 2.5rem;
			margin-bottom: 1rem;
		}

		.blog-post-body :global(h2)::before {
			content: "## ";
			color: var(--theme-muted);
		}

		.blog-post-body :global(h3)::before {
			content: "### ";
			color: var(--theme-muted);
		}

		.blog-post-body :global(a) {
			color: var(--theme-accent);
			text-decoration: none;
			border-bottom: 2px solid var(--theme-accent);
			transition: all 0.15s ease;
		}

		.blog-post-body :global(a:hover) {
			background: var(--theme-accent);
			color: var(--theme-bg);
		}

		.blog-post-body :global(pre) {
			border: 4px solid var(--theme-accent);
			border-radius: 0;
			background: var(--theme-bg-secondary);
		}

		.blog-post-body :global(code) {
			font-family: 'JetBrains Mono', monospace;
		}

		.blog-post-body :global(blockquote) {
			border-left: 4px solid var(--theme-accent);
			background: var(--theme-bg-secondary);
			padding: 1rem 1.5rem;
			margin: 1.5rem 0;
			font-style: normal;
		}

		/* TOC Sidebar */
		.blog-post-toc {
			position: sticky;
			top: 2rem;
			height: fit-content;
		}

		.toc-container {
			padding: 1.5rem;
		}

		.toc-toggle {
			display: flex;
			align-items: center;
			justify-content: space-between;
			width: 100%;
			background: none;
			border: none;
			cursor: pointer;
			padding: 0;
			text-align: left;
		}

		.toc-title {
			font-family: 'JetBrains Mono', monospace;
			font-size: 1rem;
			font-weight: 700;
			margin: 0;
			text-transform: uppercase;
			color: var(--theme-text);
		}

		.toc-chevron {
			width: 1.25rem;
			height: 1.25rem;
			color: var(--theme-accent);
			transition: transform 0.3s ease;
			flex-shrink: 0;
		}

		.toc-expanded .toc-chevron {
			transform: rotate(180deg);
		}

		.toc-list {
			list-style: none;
			padding: 0;
			margin: 0;
			margin-top: 1rem;
		}

		.toc-item {
			margin-bottom: 0.5rem;
		}

		.toc-item a {
			display: flex;
			align-items: flex-start;
			gap: 0.5rem;
			padding: 0.5rem;
			font-family: 'JetBrains Mono', monospace;
			font-size: 0.75rem;
			color: var(--theme-muted);
			text-decoration: none;
			text-transform: uppercase;
			transition: all 0.15s ease;
			border: 2px solid transparent;
		}

		.toc-item a:hover {
			color: var(--theme-accent);
			border-color: var(--theme-accent);
			background: rgba(218, 255, 1, 0.05);
		}

		.toc-marker {
			color: var(--theme-accent);
			flex-shrink: 0;
		}

		/* Scroll to top button */
		.scroll-to-top {
			position: fixed;
			bottom: 2rem;
			right: 2rem;
			width: 3rem;
			height: 3rem;
			background: transparent;
			color: var(--theme-accent);
			border: 4px solid var(--theme-accent);
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			opacity: 0;
			transform: translateY(100px);
			transition: all 0.15s ease;
			z-index: 100;
		}

		.scroll-to-top[data-show="true"] {
			opacity: 1;
			transform: translateY(0);
		}

		.scroll-to-top:hover {
			background: var(--theme-accent);
			color: var(--theme-bg);
			transform: translateY(0) translate(-2px, -2px);
			box-shadow: 4px 4px 0 var(--glitch-cyan);
		}

		.scroll-to-top:focus-visible {
			outline: 2px solid var(--theme-accent);
			outline-offset: 4px;
			background: var(--theme-accent);
			color: var(--theme-bg);
		}

		.toc-item a:focus-visible {
			outline: 2px solid var(--theme-accent);
			outline-offset: 2px;
			color: var(--theme-accent);
		}

		.blog-post-body :global(a:focus-visible) {
			outline: 2px solid var(--theme-accent);
			outline-offset: 2px;
		}

		@media (prefers-reduced-motion: reduce) {
			.scroll-to-top {
				transition: opacity 0.15s ease;
			}

			.scroll-to-top:hover {
				transform: translateY(0);
				box-shadow: none;
			}

			.scroll-to-top[data-show="true"] {
				transform: none;
			}
		}

		@media (max-width: 1024px) {
			.blog-post-content {
				grid-template-columns: 1fr;
				gap: 2rem;
			}

			.blog-post-toc {
				position: static;
				order: -1;
			}

			.toc-toggle {
				cursor: pointer;
			}

			.toc-toggle:hover .toc-title {
				color: var(--theme-accent);
			}

			.toc-list {
				display: none;
				max-height: 0;
				overflow: hidden;
				transition: max-height 0.3s ease, opacity 0.3s ease;
				opacity: 0;
			}

			.toc-expanded .toc-list {
				display: block;
				max-height: 500px;
				opacity: 1;
			}
		}

		@media (min-width: 1025px) {
			.toc-chevron {
				display: none;
			}

			.toc-toggle {
				cursor: default;
			}
		}

		@media (max-width: 768px) {
			.blog-post-image img {
				height: 250px;
			}

			.blog-post-title {
				font-size: 1.5rem;
			}
		}
	</style>
</BaseLayout>
