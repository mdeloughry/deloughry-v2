---
import BookmarkCategory from "@/components/BookmarkCategory";
import PageLayout from "@/layouts/Base";
import { ogFetcher } from "@/lib/ogFetchers";

const bookmarks = await (await fetch(import.meta.env.API_URL +'/bookmarks')).json();

const meta = {
  title: "Bookmarks",
  description: "A collection of bookmarks I find interesting",
};

// foreach bookmark get the url go get the opengraph data

const bookmarksWithMetadata =  await Promise.all(
  bookmarks.map(async (bookmark: any) => {
    const results = await ogFetcher(bookmark['link']);
    return {
      ...bookmark,
      metadata: results,
    }
}));

//split bookmarks into arrays grouped by categories ('useful','fun','affliate')
const usefulBookmarks = bookmarksWithMetadata.filter(bookmark => bookmark.category === 'useful');
const funBookmarks = bookmarksWithMetadata.filter(bookmark => bookmark.category === 'fun');
const affiliateBookmarks = bookmarksWithMetadata.filter(bookmark => bookmark.category === 'affiliate');

export const prerender = true
---
<script>
	const scrollBtn = document.getElementById("to-top-btn") as HTMLButtonElement;
	const targetHeader = document.getElementById("heading") as HTMLDivElement;

	function callback(entries: IntersectionObserverEntry[]) {
		entries.forEach((entry) => {
			// only show the scroll to top button when the heading is out of view
			scrollBtn.dataset.show = (!entry.isIntersecting).toString();
		});
	}

	scrollBtn.addEventListener("click", () => {
		document.documentElement.scrollTo({ top: 0, behavior: "smooth" });
	});

	const observer = new IntersectionObserver(callback);
	observer.observe(targetHeader);
</script>
<PageLayout meta={meta}>
  <div class="bookmarks-page">
    <header class="page-header">
      <h1 class="page-title" id="heading"><span class="accent-slash">//</span> Bookmarks</h1>
      <p class="page-subtitle">I find fun, useful, or just more people need to see...</p>
    </header>

    <div class="bookmarks-content">
      <main class="bookmarks-main">
        {usefulBookmarks && (<BookmarkCategory title="Useful" bookmarks={usefulBookmarks} />)}
        {funBookmarks.length > 0 && (<BookmarkCategory title="Fun" bookmarks={funBookmarks} />)}
        {affiliateBookmarks.length > 0 && (<BookmarkCategory title="Affiliate" bookmarks={affiliateBookmarks} />)}
      </main>

      <aside class="bookmarks-toc">
        <h2 class="toc-title">Table of Contents</h2>
        <ul class="toc-list">
          <li class="toc-item">
            <a href="#useful" aria-label="Scroll to section: useful">
              # useful
            </a>
          </li>
          <li class="toc-item">
            <a href="#fun" aria-label="Scroll to section: fun">
              # fun
            </a>
          </li>
          <li class="toc-item">
            <a href="#affiliate" aria-label="Scroll to section: affiliate">
              # affiliate
            </a>
          </li>
        </ul>
      </aside>
    </div>

    <button
      id="to-top-btn"
      class="scroll-to-top"
      aria-label="Back to Top"
      data-show="false"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        aria-hidden="true"
        focusable="false"
        fill="none"
        viewBox="0 0 24 24"
        stroke-width="2"
        stroke="currentColor"
        class="h-6 w-6"
      >
        <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 15.75l7.5-7.5 7.5 7.5"></path>
      </svg>
    </button>
  </div>

  <style>
    .bookmarks-page {
      display: flex;
      flex-direction: column;
      gap: var(--space-xl);
    }

    /* Page header and title styles from global.css */

    .bookmarks-content {
      display: grid;
      grid-template-columns: 1fr 280px;
      gap: var(--space-xl);
    }

    .bookmarks-main {
      min-width: 0;
    }

    .bookmarks-toc {
      position: sticky;
      top: var(--space-lg);
      height: fit-content;
      padding: var(--space-md);
      background: var(--theme-bg-secondary);
      border: var(--border-weight) solid rgba(255, 255, 255, 0.08);
      border-radius: var(--radius-subtle);
    }

    .toc-title {
      font-family: 'JetBrains Mono', monospace;
      font-size: var(--text-sm);
      font-weight: 600;
      margin: 0 0 var(--space-sm) 0;
      color: var(--color-info);
      letter-spacing: -0.01em;
    }

    .toc-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .toc-item {
      margin-bottom: var(--space-xs);
    }

    .toc-item a {
      display: block;
      padding: var(--space-xs);
      color: var(--theme-muted);
      text-decoration: none;
      font-family: 'JetBrains Mono', monospace;
      font-size: var(--text-sm);
      transition: color var(--transition-fast);
    }

    .toc-item a:hover {
      color: var(--theme-accent);
    }

    .scroll-to-top {
      position: fixed;
      bottom: var(--space-lg);
      right: var(--space-lg);
      width: 3rem;
      height: 3rem;
      background: var(--theme-accent);
      color: var(--theme-bg);
      border: none;
      border-radius: var(--radius-subtle);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transform: translateY(100px);
      transition: opacity var(--transition-medium), transform var(--transition-medium), background var(--transition-fast);
      z-index: 100;
    }

    .scroll-to-top[data-show="true"] {
      opacity: 1;
      transform: translateY(0);
    }

    .scroll-to-top:hover {
      background: var(--theme-accent-hover);
    }

    @media (max-width: 1024px) {
      .bookmarks-content {
        grid-template-columns: 1fr;
        gap: var(--space-lg);
      }

      .bookmarks-toc {
        position: static;
        order: -1;
      }
    }

    @media (prefers-reduced-motion: reduce) {
      .scroll-to-top[data-show="true"] {
        transform: none;
      }
    }
  </style>
</PageLayout>
