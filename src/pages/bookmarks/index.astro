---
import BookmarkCategory from "@/components/BookmarkCategory";
import PageLayout from "@/layouts/Base";
import { ogFetcher } from "@/lib/ogFetchers";

const bookmarks = await (await fetch(import.meta.env.API_URL +'/bookmarks')).json();

const meta = {
  title: "Bookmarks",
  description: "A collection of bookmarks I find interesting",
};

// foreach bookmark get the url go get the opengraph data
const bookmarksWithMetadata =  await Promise.all(
  bookmarks.map(async (bookmark: any) => {
    const results = await ogFetcher(bookmark['link']);
    return {
      ...bookmark,
      metadata: results,
    }
}));

//split bookmarks into arrays grouped by categories ('useful','fun','affliate')
const usefulBookmarks = bookmarksWithMetadata.filter(bookmark => bookmark.category === 'useful');
const funBookmarks = bookmarksWithMetadata.filter(bookmark => bookmark.category === 'fun');
const affiliateBookmarks = bookmarksWithMetadata.filter(bookmark => bookmark.category === 'affiliate');

export const prerender = true
---

<script>
	const scrollBtn = document.getElementById("to-top-btn") as HTMLButtonElement;
	const targetHeader = document.getElementById("heading") as HTMLDivElement;

	function callback(entries: IntersectionObserverEntry[]) {
		entries.forEach((entry) => {
			// only show the scroll to top button when the heading is out of view
			scrollBtn.dataset.show = (!entry.isIntersecting).toString();
		});
	}

	scrollBtn.addEventListener("click", () => {
		document.documentElement.scrollTo({ top: 0, behavior: "smooth" });
	});

	const observer = new IntersectionObserver(callback);
	observer.observe(targetHeader);
</script>

<PageLayout meta={meta}>
  <div class="bbs-bookmarks">
    <!-- Header -->
    <section class="header-section mb-4" aria-labelledby="heading">
      <div class="bbs-box">
        <div class="px-3 py-1 border-b border-bbs-gray flex items-center justify-between">
          <div class="flex items-center gap-2">
            <span class="text-accent" aria-hidden="true">┌─[</span>
            <h1 id="heading" class="text-bbs-cyan font-bold">LINK DATABASE</h1>
            <span class="text-accent" aria-hidden="true">]─</span>
          </div>
          <span class="text-bbs-gray text-xs">
            {bookmarksWithMetadata.length} links
          </span>
        </div>

        <div class="p-3">
          <p class="text-sm text-bbs-gray">
            <span class="text-bbs-cyan" aria-hidden="true">&gt;</span> Links I find fun, useful, or just think more people need to see...
          </p>
        </div>
      </div>
    </section>

    <!-- Content Layout -->
    <div class="flex flex-col lg:flex-row gap-4">
      <!-- Main Content -->
      <main class="flex-1 min-w-0 space-y-4">
        {usefulBookmarks.length > 0 && (
          <section aria-labelledby="useful-heading">
            <div class="bbs-box">
              <div class="px-3 py-1 border-b border-bbs-gray flex items-center gap-2">
                <span class="text-accent" aria-hidden="true">┌─[</span>
                <h2 id="useful-heading" class="text-bbs-cyan font-bold">USEFUL</h2>
                <span class="text-accent" aria-hidden="true">]─</span>
                <span class="text-bbs-gray text-xs ml-auto">{usefulBookmarks.length} links</span>
              </div>
              <div class="p-3">
                <BookmarkCategory title="Useful" bookmarks={usefulBookmarks} />
              </div>
            </div>
          </section>
        )}

        {funBookmarks.length > 0 && (
          <section aria-labelledby="fun-heading">
            <div class="bbs-box">
              <div class="px-3 py-1 border-b border-bbs-gray flex items-center gap-2">
                <span class="text-accent" aria-hidden="true">┌─[</span>
                <h2 id="fun-heading" class="text-bbs-cyan font-bold">FUN</h2>
                <span class="text-accent" aria-hidden="true">]─</span>
                <span class="text-bbs-gray text-xs ml-auto">{funBookmarks.length} links</span>
              </div>
              <div class="p-3">
                <BookmarkCategory title="Fun" bookmarks={funBookmarks} />
              </div>
            </div>
          </section>
        )}

        {affiliateBookmarks.length > 0 && (
          <section aria-labelledby="affiliate-heading">
            <div class="bbs-box">
              <div class="px-3 py-1 border-b border-bbs-gray flex items-center gap-2">
                <span class="text-accent" aria-hidden="true">┌─[</span>
                <h2 id="affiliate-heading" class="text-bbs-cyan font-bold">AFFILIATE</h2>
                <span class="text-accent" aria-hidden="true">]─</span>
                <span class="text-bbs-gray text-xs ml-auto">{affiliateBookmarks.length} links</span>
              </div>
              <div class="p-3">
                <BookmarkCategory title="Affiliate" bookmarks={affiliateBookmarks} />
              </div>
            </div>
          </section>
        )}
      </main>

      <!-- Table of Contents Sidebar -->
      <aside class="lg:w-64 lg:flex-shrink-0">
        <div class="bbs-box lg:sticky lg:top-4">
          <div class="px-3 py-1 border-b border-bbs-gray flex items-center gap-2">
            <span class="text-accent" aria-hidden="true">┌─[</span>
            <span class="text-bbs-cyan font-bold text-xs">CATEGORIES</span>
            <span class="text-accent" aria-hidden="true">]─</span>
          </div>

          <nav class="p-3" aria-label="Jump to category">
            <ul class="space-y-1 text-xs">
              <li>
                <a href="#useful-heading" class="bbs-link block py-1 hover:bg-bbs-dark-gray px-2 transition-colors">
                  <span class="text-bbs-magenta" aria-hidden="true">[1]</span> USEFUL
                </a>
              </li>
              <li>
                <a href="#fun-heading" class="bbs-link block py-1 hover:bg-bbs-dark-gray px-2 transition-colors">
                  <span class="text-bbs-magenta" aria-hidden="true">[2]</span> FUN
                </a>
              </li>
              <li>
                <a href="#affiliate-heading" class="bbs-link block py-1 hover:bg-bbs-dark-gray px-2 transition-colors">
                  <span class="text-bbs-magenta" aria-hidden="true">[3]</span> AFFILIATE
                </a>
              </li>
            </ul>
          </nav>
        </div>
      </aside>
    </div>

    <!-- Actions -->
    <section class="actions-section mt-4" aria-label="Actions">
      <div class="bbs-box">
        <nav class="p-3 flex flex-wrap gap-2 justify-center" aria-label="Bookmark navigation">
          <a href="/" class="bbs-button text-xs">
            <span aria-hidden="true">[M]</span> BACK TO MAIN
          </a>
        </nav>
      </div>
    </section>

    <!-- Scroll to top button -->
    <button
      id="to-top-btn"
      class="scroll-to-top"
      aria-label="Back to Top"
      data-show="false"
    >
      <span class="text-xs font-bold" aria-hidden="true">TOP</span>
    </button>
  </div>
</PageLayout>

<style>
  .bbs-bookmarks {
    font-family: 'IBM Plex Mono', monospace;
  }

  .scroll-to-top {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    width: 3rem;
    height: 3rem;
    background: var(--theme-bg);
    border: 1px solid var(--theme-accent);
    color: var(--theme-accent);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transform: translateY(100px);
    transition: all 0.3s ease;
    z-index: 100;
  }

  .scroll-to-top[data-show="true"] {
    opacity: 1;
    transform: translateY(0);
  }

  .scroll-to-top:hover {
    background: var(--theme-accent);
    color: #000;
  }

  .scroll-to-top:focus-visible {
    outline: 2px solid var(--bbs-cyan);
    outline-offset: 2px;
  }

  @media (prefers-reduced-motion: reduce) {
    .scroll-to-top {
      transition: none;
    }
  }
</style>
