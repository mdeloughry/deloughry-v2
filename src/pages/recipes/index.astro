---
import { getAllRecipes } from '../../lib/recipes.data';
import BaseLayout from '../../layouts/Base.astro';
import { getTagSlug, formatTagForDisplay } from '@/utils';
const recipes = await getAllRecipes();
const meta = {
	title: 'Recipes',
	description: 'Cooklang recipes with timers, scaling, and cook mode.',
	ogImage: undefined,
	articleDate: undefined,
};
---

<BaseLayout meta={meta}>
	<div class="recipes-page">
		<!-- Header -->
		<header class="page-header">
			<h1 class="page-title">Recipes</h1>
			<p class="page-subtitle">{recipes.length} dishes</p>
		</header>

		<!-- Search -->
		<div class="search-container">
			<label for="q" class="sr-only">Search recipes</label>
			<div class="search-wrapper">
				<svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<circle cx="11" cy="11" r="8"></circle>
					<path d="M21 21l-4.35-4.35"></path>
				</svg>
				<input
					type="search"
					id="q"
					placeholder="Search recipes..."
					class="search-input"
				/>
			</div>
		</div>

		<!-- Recipes Grid -->
		<div class="recipes-grid stagger-reveal" id="list">
			{recipes.map((r) => (
				<article class="brutal-card recipe-card">
					{r.image && (
						<div class="recipe-image">
							<img src={r.image} alt={r.title} loading="lazy" />
						</div>
					)}
					<div class="recipe-content">
						<div class="recipe-header">
							{r.servings && (
								<span class="servings-badge">{r.servings} servings</span>
							)}
						</div>
						<h2 class="recipe-title">
							<a href={`/recipes/${r.slug}/`}>
								{r.title}
							</a>
						</h2>
						{r.description && (
							<p class="recipe-description">{r.description}</p>
						)}
						{r.tags.length > 0 && (
							<div class="recipe-tags">
								{r.tags.map((tag) => (
									<a
										href={`/recipes/tags/${getTagSlug(tag)}`}
										class="brutal-tag"
										title={`View recipes with tag: ${formatTagForDisplay(tag)}`}
									>
										{formatTagForDisplay(tag)}
									</a>
								))}
							</div>
						)}
					</div>
				</article>
			))}
		</div>

		<script type="application/json" id="recipes-data">{JSON.stringify(recipes)}</script>
	</div>

	<script type="module">
		import Fuse from 'https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/+esm';
		import DOMPurify from 'https://cdn.jsdelivr.net/npm/dompurify@3.0.6/+esm';
		const data = JSON.parse(document.getElementById('recipes-data').textContent);
		const fuse = new Fuse(data, { keys: ['title', 'tags', 'ingredients.name', 'description'] });
		const q = document.getElementById('q');
		const list = document.getElementById('list');

		function getTagSlug(tag) {
			return encodeURIComponent(tag.toLowerCase().trim());
		}

		function escapeHtml(text) {
			const div = document.createElement('div');
			div.textContent = text;
			return div.innerHTML;
		}

		function formatTagForDisplay(tag) {
			return tag
				.split('-')
				.map(word => word.charAt(0).toUpperCase() + word.slice(1))
				.join(' ');
		}

		q.addEventListener('input', () => {
			const term = q.value.trim();
			const results = term ? fuse.search(term).map((r) => r.item) : data;
			const html = results
				.map(
					(r) => `
						<article class="brutal-card recipe-card">
							${r.image ? `
								<div class="recipe-image">
									<img src="${escapeHtml(r.image)}" alt="${escapeHtml(r.title)}" loading="lazy" />
								</div>
							` : ''}
							<div class="recipe-content">
								<div class="recipe-header">
									${r.servings ? `<span class="servings-badge">${escapeHtml(String(r.servings))} servings</span>` : ''}
								</div>
								<h2 class="recipe-title">
									<a href="/recipes/${escapeHtml(r.slug)}/">
										${escapeHtml(r.title)}
									</a>
								</h2>
								${r.description ? `<p class="recipe-description">${escapeHtml(r.description)}</p>` : ''}
								${r.tags.length ? `
									<div class="recipe-tags">
										${r.tags.map(tag => `<a href="/recipes/tags/${getTagSlug(tag)}" class="brutal-tag" title="View recipes with tag: ${escapeHtml(formatTagForDisplay(tag))}">${escapeHtml(formatTagForDisplay(tag))}</a>`).join('')}
									</div>
								` : ''}
							</div>
						</article>
					`
				)
				.join('');
			list.innerHTML = DOMPurify.sanitize(html);
		});
	</script>

	<style>
		.recipes-page {
			display: flex;
			flex-direction: column;
			gap: var(--space-xl);
		}

		/* Header */
		.page-header {
			padding-bottom: var(--space-lg);
			border-bottom: 1px solid rgba(255, 255, 255, 0.08);
		}

		.page-title {
			font-family: 'JetBrains Mono', monospace;
			font-size: var(--text-display);
			font-weight: 600;
			line-height: 1;
			margin: 0 0 var(--space-xs) 0;
			color: var(--theme-text);
			letter-spacing: -0.02em;
		}

		.page-subtitle {
			font-size: var(--text-sm);
			color: var(--theme-muted);
			margin: 0;
		}

		/* Search */
		.search-container {
			max-width: 400px;
		}

		.search-wrapper {
			display: flex;
			align-items: center;
			gap: var(--space-sm);
			border: var(--border-weight) solid rgba(255, 255, 255, 0.1);
			border-radius: var(--radius-subtle);
			background: var(--theme-bg-secondary);
			padding: 0 var(--space-sm);
			transition: border-color var(--transition-fast);
		}

		.search-wrapper:focus-within {
			border-color: var(--theme-accent);
		}

		.search-icon {
			color: var(--theme-muted);
			flex-shrink: 0;
		}

		.search-input {
			flex: 1;
			background: transparent;
			border: none;
			padding: 0.625rem 0;
			font-family: 'Outfit', system-ui, sans-serif;
			font-size: var(--text-base);
			color: var(--theme-text);
		}

		.search-input::placeholder {
			color: var(--theme-muted);
		}

		.search-input:focus {
			outline: none;
		}

		.sr-only {
			position: absolute;
			width: 1px;
			height: 1px;
			padding: 0;
			margin: -1px;
			overflow: hidden;
			clip: rect(0, 0, 0, 0);
			white-space: nowrap;
			border: 0;
		}

		/* Recipes Grid */
		.recipes-grid {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
			gap: var(--space-md);
		}

		.recipe-card {
			display: flex;
			flex-direction: column;
		}

		.recipe-image {
			position: relative;
			height: 160px;
			overflow: hidden;
			margin: calc(var(--space-md) * -1) calc(var(--space-md) * -1) var(--space-sm) calc(var(--space-md) * -1);
			border-radius: var(--radius-subtle) var(--radius-subtle) 0 0;
		}

		.recipe-image img {
			width: 100%;
			height: 100%;
			object-fit: cover;
			filter: grayscale(100%);
			transition: filter var(--transition-medium), transform var(--transition-medium);
		}

		.recipe-card:hover .recipe-image img {
			filter: grayscale(0%);
			transform: scale(1.02);
		}

		.recipe-content {
			display: flex;
			flex-direction: column;
			flex: 1;
			gap: var(--space-xs);
		}

		.recipe-header {
			display: flex;
			justify-content: flex-start;
			align-items: center;
		}

		.servings-badge {
			font-family: 'JetBrains Mono', monospace;
			font-size: var(--text-xs);
			color: var(--theme-muted);
		}

		.recipe-title {
			font-family: 'JetBrains Mono', monospace;
			font-size: var(--text-lg);
			font-weight: 600;
			margin: 0;
			line-height: 1.3;
			letter-spacing: -0.01em;
		}

		.recipe-title a {
			color: var(--theme-text);
			transition: color var(--transition-fast);
		}

		.recipe-title a:hover {
			color: var(--theme-accent);
		}

		.recipe-description {
			font-size: var(--text-sm);
			color: var(--theme-muted);
			line-height: 1.6;
			margin: 0;
		}

		.recipe-tags {
			display: flex;
			flex-wrap: wrap;
			gap: var(--space-xs);
			margin-top: auto;
			padding-top: var(--space-xs);
		}

		/* Responsive */
		@media (max-width: 768px) {
			.recipes-grid {
				grid-template-columns: 1fr;
			}
		}
	</style>
</BaseLayout>
