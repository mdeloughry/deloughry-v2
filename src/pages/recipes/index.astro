---
import { getAllRecipes } from '../../lib/recipes.data';
import BaseLayout from '../../layouts/Base.astro';
import { getTagSlug, formatTagForDisplay } from '@/utils';
const recipes = await getAllRecipes();
const meta = {
	title: 'Recipes',
	description: 'Cooklang recipes with timers, scaling, and cook mode.',
	ogImage: undefined,
	articleDate: undefined,
};
---

<BaseLayout meta={meta}>
	<div class="terminal-recipes">
		<!-- Command Header -->
		<div class="section-header" aria-hidden="true">
			<span class="prompt">$</span>
			<span class="command">find ./recipes -type f -name "*.cook"</span>
		</div>

		<!-- Page Title -->
		<header class="recipes-header">
			<h1 class="recipes-title glow">
				<span class="title-prefix" aria-hidden="true"># </span>RECIPES<span class="cursor-inline" aria-hidden="true"></span>
			</h1>
			<p class="recipes-subtitle">
				<span class="comment" aria-hidden="true">// </span>Discover delicious recipes with interactive timers and cook mode
			</p>
		</header>

		<!-- Search Box -->
		<div class="search-section">
			<div class="search-prompt">
				<span class="prompt">$</span>
				<span class="command">grep -i "</span>
				<input
					type="search"
					id="q"
					placeholder="search_term"
					class="search-input"
					aria-label="Search recipes"
				/>
				<span class="command">" ./recipes/*</span>
			</div>
		</div>

		<!-- Recipe Listing -->
		<div class="recipes-grid" id="list" role="list" aria-label="Recipes">
			{recipes.map((r) => (
				<article class="recipe-card terminal-window" role="listitem">
					<div class="terminal-header" aria-hidden="true">
						<div class="terminal-dots">
							<span class="terminal-dot red"></span>
							<span class="terminal-dot yellow"></span>
							<span class="terminal-dot green"></span>
						</div>
						<span class="terminal-title">~/{r.slug}.cook</span>
					</div>
					<div class="terminal-content">
						{r.image && (
							<div class="recipe-image">
								<img src={r.image} alt="" aria-hidden="true" loading="lazy" />
							</div>
						)}
						<h2 class="recipe-title">
							<a href={`/recipes/${r.slug}/`} class="recipe-link flicker-hover">
								{r.title}
							</a>
						</h2>
						{r.description && (
							<p class="recipe-description">
								<span class="comment" aria-hidden="true">// </span>{r.description}
							</p>
						)}
						{r.tags.length > 0 && (
							<div class="recipe-tags">
								<span class="tags-label" aria-hidden="true">tags:</span>
								{r.tags.map((tag) => (
									<a href={`/recipes/tags/${getTagSlug(tag)}`} class="terminal-tag" title={`View recipes with tag: ${formatTagForDisplay(tag)}`}>
										<span aria-hidden="true">[{formatTagForDisplay(tag)}]</span>
										<span class="sr-only">Tag: {formatTagForDisplay(tag)}</span>
									</a>
								))}
							</div>
						)}
						{r.servings && (
							<div class="recipe-meta">
								<span class="meta-key" aria-hidden="true">servings:</span>
								<span class="meta-value">{r.servings} <span class="sr-only">servings</span></span>
							</div>
						)}
						<div class="recipe-action">
							<a href={`/recipes/${r.slug}/`} class="action-link">
								<span aria-hidden="true">$ ./cook --recipe={r.slug}</span>
								<span class="sr-only">View {r.title} recipe</span>
							</a>
						</div>
					</div>
				</article>
			))}
		</div>

		<script type="application/json" id="recipes-data">{JSON.stringify(recipes)}</script>
	</div>

	<script type="module">
		import Fuse from 'https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/+esm';
		const data = JSON.parse(document.getElementById('recipes-data').textContent);
		const fuse = new Fuse(data, { keys: ['title', 'tags', 'ingredients.name', 'description'] });
		const q = document.getElementById('q');
		const list = document.getElementById('list');

		// Helper to escape HTML - prevents XSS
		function escapeHtml(text) {
			const div = document.createElement('div');
			div.textContent = text;
			return div.innerHTML;
		}

		q.addEventListener('input', () => {
			const term = q.value.trim();
			const results = term ? fuse.search(term).map((r) => r.item) : data;
			// Note: All dynamic content is escaped via escapeHtml() to prevent XSS
			list.innerHTML = results
				.map(
					(r) => `
						<article class="recipe-card terminal-window">
							<div class="terminal-header">
								<div class="terminal-dots">
									<span class="terminal-dot red"></span>
									<span class="terminal-dot yellow"></span>
									<span class="terminal-dot green"></span>
								</div>
								<span class="terminal-title">~/${escapeHtml(r.slug)}.cook</span>
							</div>
							<div class="terminal-content">
								${r.image ? `
									<div class="recipe-image">
										<img src="${escapeHtml(r.image)}" alt="${escapeHtml(r.title)}" loading="lazy" />
									</div>
								` : ''}
								<h2 class="recipe-title">
									<a href="/recipes/${escapeHtml(r.slug)}/" class="recipe-link flicker-hover">
										${escapeHtml(r.title)}
									</a>
								</h2>
								${r.description ? `
									<p class="recipe-description">
										<span class="comment">// </span>${escapeHtml(r.description)}
									</p>
								` : ''}
								${r.tags.length ? `
									<div class="recipe-tags">
										<span class="tags-label">tags:</span>
										${r.tags.map(tag => `<a href="/recipes/tags/${encodeURIComponent(tag.toLowerCase().trim())}" class="terminal-tag" title="View recipes with tag: ${escapeHtml(tag)}">[${escapeHtml(tag)}]</a>`).join('')}
									</div>
								` : ''}
								${r.servings ? `
									<div class="recipe-meta">
										<span class="meta-key">servings:</span>
										<span class="meta-value">${escapeHtml(String(r.servings))}</span>
									</div>
								` : ''}
								<div class="recipe-action">
									<a href="/recipes/${escapeHtml(r.slug)}/" class="action-link">
										$ ./cook --recipe=${escapeHtml(r.slug)}
									</a>
								</div>
							</div>
						</article>
					`
				)
				.join('');
		});
	</script>
</BaseLayout>

<style>
	.terminal-recipes {
		font-family: 'JetBrains Mono', monospace;
	}

	.section-header {
		display: flex;
		gap: 0.5rem;
		margin-bottom: 1rem;
		flex-wrap: wrap;
	}

	.prompt {
		color: var(--theme-accent);
	}

	.command {
		color: var(--theme-link);
	}

	.recipes-header {
		margin-bottom: 2rem;
	}

	.recipes-title {
		font-size: 2.5rem;
		color: var(--theme-accent);
		margin: 0 0 0.5rem 0;
		display: flex;
		align-items: center;
	}

	.title-prefix {
		color: var(--theme-quote);
	}

	.recipes-subtitle {
		margin: 0;
		font-size: 0.875rem;
	}

	.comment {
		color: var(--theme-quote);
	}

	.glow {
		text-shadow: 0 0 5px var(--theme-accent), 0 0 10px var(--theme-accent);
	}

	/* Search Section */
	.search-section {
		margin-bottom: 2rem;
	}

	.search-prompt {
		display: flex;
		align-items: center;
		gap: 0.25rem;
		padding: 0.75rem 1rem;
		border: 1px solid var(--theme-text);
		background: rgba(0, 255, 135, 0.02);
		flex-wrap: wrap;
	}

	.search-input {
		background: transparent;
		border: none;
		color: var(--theme-accent);
		font-family: 'JetBrains Mono', monospace;
		font-size: 1rem;
		padding: 0.25rem;
		min-width: 150px;
		flex: 1;
	}

	.search-input:focus {
		outline: none;
	}

	.search-input::placeholder {
		color: var(--theme-quote);
		font-style: italic;
	}

	/* Recipes Grid */
	.recipes-grid {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
		gap: 1.5rem;
	}

	/* Recipe Card */
	.recipe-card {
		border: 1px solid var(--theme-text);
		transition: all 0.2s ease;
	}

	.recipe-card:hover {
		border-color: var(--theme-accent);
		box-shadow: 0 0 20px rgba(0, 255, 135, 0.1);
	}

	:global(.terminal-header) {
		display: flex;
		align-items: center;
		gap: 1rem;
		padding: 0.5rem 1rem;
		background: rgba(0, 255, 135, 0.05);
		border-bottom: 1px solid var(--theme-text);
	}

	:global(.terminal-dots) {
		display: flex;
		gap: 0.5rem;
	}

	:global(.terminal-dot) {
		width: 10px;
		height: 10px;
		border-radius: 50%;
	}

	:global(.terminal-dot.red) { background: #FF4757; box-shadow: 0 0 5px #FF4757; }
	:global(.terminal-dot.yellow) { background: #DAFF01; box-shadow: 0 0 5px #DAFF01; }
	:global(.terminal-dot.green) { background: #00FF87; box-shadow: 0 0 5px #00FF87; }

	:global(.terminal-title) {
		flex: 1;
		color: var(--theme-quote);
		font-size: 0.75rem;
	}

	:global(.terminal-content) {
		padding: 1.25rem;
	}

	.recipe-image {
		margin-bottom: 1rem;
		overflow: hidden;
		border: 1px solid var(--theme-text);
	}

	.recipe-image img {
		width: 100%;
		height: 150px;
		object-fit: cover;
		filter: grayscale(100%) contrast(1.1);
		transition: filter 0.3s ease;
	}

	.recipe-card:hover .recipe-image img {
		filter: grayscale(0%) contrast(1);
	}

	:global(.recipe-title) {
		margin: 0 0 0.75rem 0;
		font-size: 1.25rem;
	}

	:global(.recipe-link) {
		color: var(--theme-link);
		text-decoration: none;
		transition: all 0.2s ease;
	}

	:global(.recipe-link:hover) {
		color: var(--theme-accent);
		text-shadow: 0 0 5px var(--theme-accent);
	}

	:global(.recipe-description) {
		margin: 0 0 1rem 0;
		font-size: 0.875rem;
		line-height: 1.5;
		color: var(--theme-text);
	}

	:global(.recipe-tags) {
		display: flex;
		flex-wrap: wrap;
		align-items: center;
		gap: 0.5rem;
		margin-bottom: 0.75rem;
		font-size: 0.75rem;
	}

	:global(.tags-label) {
		color: var(--theme-quote);
	}

	:global(.terminal-tag) {
		color: var(--theme-text);
		text-decoration: none;
		transition: color 0.2s ease;
	}

	:global(.terminal-tag:hover) {
		color: var(--theme-accent);
	}

	:global(.recipe-meta) {
		font-size: 0.75rem;
		margin-bottom: 0.75rem;
	}

	:global(.meta-key) {
		color: var(--theme-quote);
	}

	:global(.meta-value) {
		color: var(--theme-accent);
	}

	:global(.recipe-action) {
		margin-top: 1rem;
		padding-top: 1rem;
		border-top: 1px dashed var(--theme-text);
	}

	:global(.action-link) {
		display: inline-block;
		color: var(--theme-accent);
		text-decoration: none;
		font-size: 0.875rem;
		transition: all 0.2s ease;
	}

	:global(.action-link:hover) {
		text-shadow: 0 0 5px var(--theme-accent);
	}

	/* Responsive */
	@media (max-width: 768px) {
		.recipes-grid {
			grid-template-columns: 1fr;
		}

		.recipes-title {
			font-size: 2rem;
		}
	}
</style>
