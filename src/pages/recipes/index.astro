---
import { getAllRecipes } from '../../lib/recipes.data';
import BaseLayout from '../../layouts/Base.astro';
import { getTagSlug, formatTagForDisplay } from '@/utils';
const recipes = await getAllRecipes();
const meta = {
	title: 'Recipes',
	description: 'Cooklang recipes with timers, scaling, and cook mode.',
	ogImage: undefined,
	articleDate: undefined,
};
---

<BaseLayout meta={meta}>
	<div class="bbs-recipes">
		<!-- Header -->
		<section class="header-section mb-4" aria-labelledby="recipes-heading">
			<div class="bbs-box">
				<div class="px-3 py-1 border-b border-bbs-gray flex items-center justify-between">
					<div class="flex items-center gap-2">
						<span class="text-accent" aria-hidden="true">┌─[</span>
						<h1 id="recipes-heading" class="text-bbs-cyan font-bold">RECIPE DATABASE</h1>
						<span class="text-accent" aria-hidden="true">]─</span>
					</div>
					<span class="text-bbs-gray text-xs">
						{recipes.length} recipes
					</span>
				</div>

				<div class="p-3">
					<p class="text-sm text-bbs-gray">
						<span class="text-bbs-cyan" aria-hidden="true">&gt;</span> Discover delicious recipes with interactive timers and cook mode
					</p>
				</div>
			</div>
		</section>

		<!-- Search Box -->
		<section class="search-section mb-4" aria-label="Search">
			<div class="bbs-box">
				<div class="p-3">
					<label for="q" class="text-bbs-cyan text-sm block mb-2">
						<span class="text-accent" aria-hidden="true">&gt;</span> SEARCH RECIPES:
					</label>
					<input
						type="search"
						id="q"
						name="q"
						placeholder="Type to search..."
						class="bbs-input w-full"
						autocomplete="off"
						aria-describedby="search-hint"
					/>
					<p id="search-hint" class="sr-only">Search by recipe name, tags, or ingredients</p>
				</div>
			</div>
		</section>

		<!-- Recipes List -->
		<section class="recipes-list" aria-labelledby="list-heading">
			<h2 id="list-heading" class="sr-only">Recipe List</h2>
			<div class="bbs-box">
				<!-- Table Header - decorative -->
				<div class="hidden sm:grid grid-cols-12 gap-2 px-3 py-2 border-b border-accent text-xs font-bold" aria-hidden="true">
					<div class="col-span-1 text-bbs-magenta">#</div>
					<div class="col-span-5 text-bbs-cyan">RECIPE NAME</div>
					<div class="col-span-2 text-bbs-gray">SERVINGS</div>
					<div class="col-span-4 text-bbs-gray">TAGS</div>
				</div>

				<!-- Recipes -->
				<div class="divide-y divide-bbs-gray" id="list" role="list" aria-live="polite">
					{recipes.map((r, index) => (
						<article class="recipe-item p-3 hover:bg-bbs-dark-gray transition-colors" data-recipe={JSON.stringify(r)} role="listitem">
							<div class="sm:grid sm:grid-cols-12 sm:gap-2 sm:items-start">
								<!-- Number - decorative -->
								<div class="hidden sm:block col-span-1 text-bbs-magenta text-xs recipe-number" aria-hidden="true">
									[{String(index + 1).padStart(2, '0')}]
								</div>

								<!-- Title -->
								<div class="sm:col-span-5 mb-2 sm:mb-0">
									<span class="sm:hidden text-bbs-magenta text-xs recipe-number-mobile" aria-hidden="true">[{String(index + 1).padStart(2, '0')}] </span>
									<h3 class="text-sm inline sm:block">
										<a href={`/recipes/${r.slug}/`} class="bbs-link text-bbs-cyan hover:text-accent transition-colors recipe-title">
											{r.title.toUpperCase()}
										</a>
									</h3>
									{r.description && (
										<p class="text-xs text-bbs-gray mt-1 line-clamp-1 recipe-description">{r.description}</p>
									)}
								</div>

								<!-- Servings -->
								<div class="sm:col-span-2 mb-2 sm:mb-0 recipe-servings">
									{r.servings && (
										<span class="text-bbs-cyan text-xs">
											{r.servings} <span class="text-bbs-gray">servings</span>
										</span>
									)}
								</div>

								<!-- Tags -->
								<div class="sm:col-span-4 recipe-tags">
									{r.tags.length > 0 && (
										<div class="flex flex-wrap gap-1">
											{r.tags.slice(0, 3).map((tag) => (
												<a
													href={`/recipes/tags/${getTagSlug(tag)}`}
													class="bbs-tag text-xs"
													title={`View recipes with tag: ${formatTagForDisplay(tag)}`}
												>
													{formatTagForDisplay(tag)}
												</a>
											))}
											{r.tags.length > 3 && (
												<span class="text-bbs-gray text-xs">+{r.tags.length - 3}</span>
											)}
										</div>
									)}
								</div>
							</div>
						</article>
					))}
				</div>
			</div>
		</section>

		<!-- Actions -->
		<section class="actions-section mt-4" aria-label="Actions">
			<div class="bbs-box">
				<nav class="p-3 flex flex-wrap gap-2 justify-center" aria-label="Recipe navigation">
					<a href="/recipes/tags" class="bbs-button text-xs">
						<span aria-hidden="true">[T]</span> VIEW ALL TAGS
					</a>
					<a href="/recipes/shopping-list" class="bbs-button text-xs">
						<span aria-hidden="true">[S]</span> SHOPPING LIST
					</a>
					<a href="/" class="bbs-button text-xs">
						<span aria-hidden="true">[M]</span> BACK TO MAIN
					</a>
				</nav>
			</div>
		</section>

		<script type="application/json" id="recipes-data">{JSON.stringify(recipes)}</script>
	</div>

	<script type="module">
		import Fuse from 'https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/+esm';
		const data = JSON.parse(document.getElementById('recipes-data').textContent);
		const fuse = new Fuse(data, { keys: ['title', 'tags', 'ingredients.name', 'description'] });
		const q = document.getElementById('q');
		const list = document.getElementById('list');
		const allItems = Array.from(list.querySelectorAll('.recipe-item'));

		q.addEventListener('input', () => {
			const term = q.value.trim();

			if (!term) {
				// Show all items
				allItems.forEach((item, index) => {
					item.style.display = '';
					const numEl = item.querySelector('.recipe-number');
					const numMobileEl = item.querySelector('.recipe-number-mobile');
					if (numEl) numEl.textContent = `[${String(index + 1).padStart(2, '0')}]`;
					if (numMobileEl) numMobileEl.textContent = `[${String(index + 1).padStart(2, '0')}] `;
				});
				return;
			}

			const results = fuse.search(term).map((r) => r.item.slug);

			let visibleIndex = 0;
			allItems.forEach((item) => {
				const recipe = JSON.parse(item.dataset.recipe);
				if (results.includes(recipe.slug)) {
					item.style.display = '';
					visibleIndex++;
					const numEl = item.querySelector('.recipe-number');
					const numMobileEl = item.querySelector('.recipe-number-mobile');
					if (numEl) numEl.textContent = `[${String(visibleIndex).padStart(2, '0')}]`;
					if (numMobileEl) numMobileEl.textContent = `[${String(visibleIndex).padStart(2, '0')}] `;
				} else {
					item.style.display = 'none';
				}
			});
		});
	</script>
</BaseLayout>

<style>
	.bbs-recipes {
		font-family: 'IBM Plex Mono', monospace;
	}

	.line-clamp-1 {
		display: -webkit-box;
		-webkit-line-clamp: 1;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}
</style>
