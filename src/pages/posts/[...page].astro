---
import type { Page, GetStaticPathsOptions } from "astro";
import type { CollectionEntry } from "astro:content";
import { getCollection } from "astro:content";
import PageLayout from "@/layouts/Base";
import Pagination from "@/components/Paginator";
import { getUniqueTags, sortMDByDate, getFormattedDate, getTagSlug, formatTagForDisplay } from "@/utils";

export async function getStaticPaths({ paginate }: GetStaticPathsOptions) {
	const allPosts = await getCollection("post");
	const allPostsByDate = sortMDByDate(allPosts);
	const uniqueTags = getUniqueTags(allPosts);
	return paginate(allPostsByDate, { props: { uniqueTags }, pageSize: 10 });
}

interface Props {
	page: Page<CollectionEntry<"post">>;
	uniqueTags: string[];
}

const { page } = Astro.props;

const meta = {
	title: "Posts",
	description: "A collection of posts by me!",
};

const paginationProps = {
	...(page.url.prev && {
		prevUrl: {
			url: page.url.prev,
			text: `Previous`,
			srLabel: `Go to previous page`,
		},
	}),
	...(page.url.next && {
		nextUrl: {
			url: page.url.next,
			text: `Next`,
			srLabel: `Go to next page`,
		},
	}),
};
export const prerender = true;
---

<PageLayout meta={meta}>
	<div class="bbs-posts">
		<!-- Header -->
		<section class="header-section mb-4" aria-labelledby="posts-heading">
			<div class="bbs-box">
				<div class="px-3 py-1 border-b border-bbs-gray flex items-center justify-between">
					<div class="flex items-center gap-2">
						<span class="text-accent" aria-hidden="true">┌─[</span>
						<h1 id="posts-heading" class="text-bbs-cyan font-bold">MESSAGE BOARD</h1>
						<span class="text-accent" aria-hidden="true">]─</span>
					</div>
					<span class="text-bbs-gray text-xs">
						Page {page.currentPage} of {page.lastPage}
					</span>
				</div>

				<div class="p-3">
					<p class="text-sm text-bbs-gray">
						<span class="text-bbs-cyan" aria-hidden="true">&gt;</span> Thoughts, tutorials, and insights on web development and technology
					</p>
					<p class="text-xs text-bbs-gray mt-2">
						Total Messages: <span class="text-accent">{page.total}</span>
					</p>
				</div>
			</div>
		</section>

		<!-- Posts List -->
		<section class="posts-list" aria-label="Blog posts">
			<div class="bbs-box">
				<!-- Table Header - decorative on desktop -->
				<div class="hidden sm:grid grid-cols-12 gap-2 px-3 py-2 border-b border-accent text-xs font-bold" aria-hidden="true">
					<div class="col-span-1 text-bbs-magenta">#</div>
					<div class="col-span-2 text-bbs-gray">DATE</div>
					<div class="col-span-7 text-bbs-cyan">SUBJECT</div>
					<div class="col-span-2 text-bbs-gray text-right">TAGS</div>
				</div>

				<!-- Posts -->
				<div class="divide-y divide-bbs-gray">
					{page.data.map((p, index) => {
						const postNumber = (page.currentPage - 1) * 10 + index + 1;
						return (
							<article class="p-3 hover:bg-bbs-dark-gray transition-colors">
								<div class="sm:grid sm:grid-cols-12 sm:gap-2 sm:items-start">
									<!-- Number - decorative -->
									<div class="hidden sm:block col-span-1 text-bbs-magenta text-xs" aria-hidden="true">
										[{String(postNumber).padStart(2, '0')}]
									</div>

									<!-- Date -->
									<time
										datetime={p.data.publishDate.toISOString()}
										class="block sm:col-span-2 text-xs text-bbs-gray mb-1 sm:mb-0"
									>
										<span class="sm:hidden text-bbs-magenta" aria-hidden="true">[{String(postNumber).padStart(2, '0')}] </span>
										{getFormattedDate(new Date(p.data.publishDate), { month: "short" })}
									</time>

									<!-- Title & Description -->
									<div class="sm:col-span-7">
										<h2 class="text-sm">
											<a href={`/posts/${p.slug}/`} class="bbs-link text-bbs-cyan hover:text-accent transition-colors">
												{p.data.title}
											</a>
										</h2>
										{p.data.description && (
											<p class="text-xs text-bbs-gray mt-1 line-clamp-2">{p.data.description}</p>
										)}
									</div>

									<!-- Tags -->
									<div class="sm:col-span-2 mt-2 sm:mt-0 sm:text-right">
										{p.data.tags && p.data.tags.length > 0 && (
											<div class="flex flex-wrap gap-1 sm:justify-end">
												{p.data.tags.slice(0, 2).map((tag) => (
													<a
														href={`/tags/${getTagSlug(tag)}`}
														class="bbs-tag text-xs"
														title={`View posts with tag: ${formatTagForDisplay(tag)}`}
													>
														{formatTagForDisplay(tag)}
													</a>
												))}
												{p.data.tags.length > 2 && (
													<span class="text-bbs-gray text-xs">+{p.data.tags.length - 2}</span>
												)}
											</div>
										)}
									</div>
								</div>
							</article>
						);
					})}
				</div>

				<!-- Pagination -->
				<nav class="px-3 py-2 border-t border-bbs-gray flex items-center justify-between text-xs" aria-label="Pagination">
					<Pagination {...paginationProps} />
				</nav>
			</div>
		</section>

		<!-- Quick Actions -->
		<section class="quick-actions mt-4" aria-label="Quick actions">
			<div class="bbs-box">
				<nav class="p-3 flex flex-wrap gap-2 justify-center">
					<a href="/tags" class="bbs-button text-xs">
						<span aria-hidden="true">[T]</span> VIEW ALL TAGS
					</a>
					<a href="/" class="bbs-button text-xs">
						<span aria-hidden="true">[M]</span> BACK TO MAIN
					</a>
				</nav>
			</div>
		</section>
	</div>
</PageLayout>

<style>
	.bbs-posts {
		font-family: 'IBM Plex Mono', monospace;
	}

	.line-clamp-2 {
		display: -webkit-box;
		-webkit-line-clamp: 2;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}
</style>
