---
import type { Page, GetStaticPathsOptions } from "astro";
import type { CollectionEntry } from "astro:content";
import { getCollection } from "astro:content";
import PageLayout from "@/layouts/Base";
import Pagination from "@/components/Paginator";
import { getUniqueTags, sortMDByDate, getFormattedDate, getTagSlug, formatTagForDisplay } from "@/utils";

export async function getStaticPaths({ paginate }: GetStaticPathsOptions) {
	const allPosts = await getCollection("post");
	const allPostsByDate = sortMDByDate(allPosts);
	const uniqueTags = getUniqueTags(allPosts);
	return paginate(allPostsByDate, { props: { uniqueTags }, pageSize: 10 });
}

interface Props {
	page: Page<CollectionEntry<"post">>;
	uniqueTags: string[];
}

const { page } = Astro.props;

const meta = {
	title: "Posts",
	description: "A collection of posts by me!",
};

const paginationProps = {
	...(page.url.prev && {
		prevUrl: {
			url: page.url.prev,
			text: `<< prev`,
		},
	}),
	...(page.url.next && {
		nextUrl: {
			url: page.url.next,
			text: `next >>`,
		},
	}),
};

// Format file size-like metadata
function formatAsSize(text: string): string {
  const words = text?.split(' ').length || 0;
  return `${words * 50}B`;
}

// Format date as ls -la style
function formatLsDate(date: Date): string {
  const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
  const month = months[date.getMonth()];
  const day = date.getDate().toString().padStart(2, ' ');
  const year = date.getFullYear();
  return `${month} ${day} ${year}`;
}

export const prerender = true;
---

<PageLayout meta={meta}>
	<div class="terminal-posts">
		<!-- Command Header -->
		<div class="section-header" aria-hidden="true">
			<span class="prompt">$</span>
			<span class="command">ls -la ./blog</span>
		</div>

		<!-- Page Title -->
		<header class="posts-header">
			<h1 class="posts-title glow">
				<span class="title-prefix" aria-hidden="true"># </span>POSTS<span class="cursor-inline" aria-hidden="true"></span>
			</h1>
			<p class="posts-subtitle">
				<span class="comment" aria-hidden="true">// </span>Thoughts, tutorials, and insights on web development and technology
			</p>
		</header>

		<!-- Directory Listing -->
		<div class="file-listing" role="list" aria-label="Blog posts">
			<div class="file-header" aria-hidden="true">
				<span class="col-perms">drwxr-xr-x</span>
				<span class="col-size">SIZE</span>
				<span class="col-date">DATE</span>
				<span class="col-name">NAME</span>
			</div>

			{page.data.map((p) => (
				<article class="file-row flicker-hover" role="listitem">
					<span class="col-perms" aria-hidden="true">-rw-r--r--</span>
					<span class="col-size" aria-hidden="true">{formatAsSize(p.data.description || '')}</span>
					<time class="col-date" datetime={p.data.publishDate.toISOString()}>{formatLsDate(p.data.publishDate)}</time>
					<div class="col-name">
						<a href={`/posts/${p.slug}/`} class="file-link">
							<span aria-hidden="true">{p.data.title.toLowerCase().replace(/\s+/g, '-')}.md</span>
							<span class="sr-only">{p.data.title}</span>
						</a>
						{p.data.tags && p.data.tags.length > 0 && (
							<span class="file-tags">
								{p.data.tags.slice(0, 3).map((tag) => (
									<a href={`/tags/${getTagSlug(tag)}`} class="terminal-tag" title={`View posts with tag: ${formatTagForDisplay(tag)}`}>
										<span aria-hidden="true">[{formatTagForDisplay(tag)}]</span>
										<span class="sr-only">Tag: {formatTagForDisplay(tag)}</span>
									</a>
								))}
							</span>
						)}
						{p.data.description && (
							<span class="file-desc">
								<span class="comment" aria-hidden="true">// </span>{p.data.description.substring(0, 60)}...
							</span>
						)}
					</div>
				</article>
			))}

			<div class="file-footer" aria-live="polite">
				<span class="text-quote">
					Page {page.currentPage} of {page.lastPage} | total {page.total} files
				</span>
			</div>
		</div>

		<!-- Pagination -->
		<div class="pagination-wrapper">
			<Pagination {...paginationProps} />
		</div>
	</div>
</PageLayout>

<style>
	.terminal-posts {
		font-family: 'JetBrains Mono', monospace;
	}

	.section-header {
		display: flex;
		gap: 0.5rem;
		margin-bottom: 1rem;
	}

	.prompt {
		color: var(--theme-accent);
	}

	.command {
		color: var(--theme-link);
	}

	.posts-header {
		margin-bottom: 2rem;
	}

	.posts-title {
		font-size: 2.5rem;
		color: var(--theme-accent);
		margin: 0 0 0.5rem 0;
		display: flex;
		align-items: center;
	}

	.title-prefix {
		color: var(--theme-quote);
	}

	.posts-subtitle {
		margin: 0;
		font-size: 0.875rem;
	}

	.comment {
		color: var(--theme-quote);
	}

	.glow {
		text-shadow: 0 0 5px var(--theme-accent), 0 0 10px var(--theme-accent);
	}

	/* File Listing */
	.file-listing {
		border: 1px solid var(--theme-text);
		overflow-x: auto;
	}

	.file-header {
		display: grid;
		grid-template-columns: 100px 60px 100px 1fr;
		gap: 1rem;
		padding: 0.75rem 1rem;
		background: rgba(0, 255, 135, 0.05);
		border-bottom: 1px dashed var(--theme-text);
		font-size: 0.75rem;
		color: var(--theme-quote);
	}

	.file-row {
		display: grid;
		grid-template-columns: 100px 60px 100px 1fr;
		gap: 1rem;
		padding: 0.75rem 1rem;
		font-size: 0.875rem;
		border-bottom: 1px dotted rgba(0, 255, 135, 0.2);
		transition: background 0.2s ease;
	}

	.file-row:hover {
		background: rgba(0, 255, 135, 0.05);
	}

	.col-perms {
		color: var(--theme-quote);
		font-size: 0.75rem;
	}

	.col-size {
		color: var(--theme-quote);
		text-align: right;
	}

	.col-date {
		color: var(--theme-text);
	}

	.col-name {
		display: flex;
		flex-direction: column;
		gap: 0.25rem;
	}

	.file-link {
		color: var(--theme-link);
		text-decoration: none;
		transition: all 0.2s ease;
	}

	.file-link:hover {
		color: var(--theme-accent);
		text-shadow: 0 0 5px var(--theme-accent);
	}

	.file-tags {
		display: flex;
		gap: 0.25rem;
		flex-wrap: wrap;
	}

	.terminal-tag {
		color: var(--theme-text);
		font-size: 0.7rem;
		text-decoration: none;
		transition: color 0.2s ease;
	}

	.terminal-tag:hover {
		color: var(--theme-accent);
	}

	.file-desc {
		font-size: 0.75rem;
	}

	.file-footer {
		display: flex;
		justify-content: space-between;
		align-items: center;
		padding: 0.75rem 1rem;
		border-top: 1px dashed var(--theme-text);
		font-size: 0.75rem;
	}

	.text-quote {
		color: var(--theme-quote);
	}

	/* Pagination */
	.pagination-wrapper {
		margin-top: 2rem;
		padding: 1rem;
		border: 1px dashed var(--theme-text);
		display: flex;
		justify-content: center;
	}

	.pagination-wrapper :global(nav) {
		display: flex;
		gap: 2rem;
	}

	.pagination-wrapper :global(a) {
		color: var(--theme-link);
		text-decoration: none;
		padding: 0.5rem 1rem;
		border: 1px solid var(--theme-text);
		transition: all 0.2s ease;
	}

	.pagination-wrapper :global(a:hover) {
		color: var(--theme-accent);
		border-color: var(--theme-accent);
		text-shadow: 0 0 5px var(--theme-accent);
	}

	/* Responsive */
	@media (max-width: 768px) {
		.file-header,
		.file-row {
			grid-template-columns: 1fr;
			gap: 0.25rem;
		}

		.col-perms,
		.col-size {
			display: none;
		}

		.col-date {
			font-size: 0.75rem;
			color: var(--theme-quote);
		}

		.posts-title {
			font-size: 2rem;
		}
	}
</style>
