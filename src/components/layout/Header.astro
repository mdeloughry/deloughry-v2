---
const url = new URL(Astro.request.url);

const menuLinks = [
  { title: "Home", path: "/" },
  { title: "About", path: "/about" },
  { title: "Blog", path: "/posts" },
  { title: "Recipes", path: "/recipes" },
  { title: "Playlists", path: "/playlists" },
  { title: "Projects", path: "/projects" },
  { title: "Bookmarks", path: "/bookmarks" },
];
---

<script>
  import { toggleClass } from "@/utils";

  function setupMenu() {
    const header = document.getElementById("main-header");
    const toggleMenuButton = document.getElementById("toggle-navigation-menu");
    const nav = document.getElementById("navigation-menu");

    if (!header || !toggleMenuButton) return;

    // Remove any existing listener by cloning
    const newButton = toggleMenuButton.cloneNode(true) as HTMLButtonElement;
    toggleMenuButton.parentNode?.replaceChild(newButton, toggleMenuButton);

    newButton.addEventListener("click", () => {
      const isOpen = header.classList.contains("menu-open");
      toggleClass(header, "menu-open");
      newButton.setAttribute("aria-expanded", (!isOpen).toString());
    });

    // Close menu when clicking a nav link
    nav?.querySelectorAll("a").forEach((link) => {
      link.addEventListener("click", () => {
        header.classList.remove("menu-open");
        newButton.setAttribute("aria-expanded", "false");
      });
    });
  }

  // Run on initial load and after Astro page transitions
  setupMenu();
  document.addEventListener("astro:after-swap", setupMenu);
</script>

<header id="main-header" class="group relative mb-16 pb-8 border-b border-white/10">
  <div class="flex flex-col gap-6">
    <!-- Logo / Name -->
    <a
      href="/"
      class="inline-block"
      aria-current={url.pathname === "/" ? "page" : false}
    >
      <h1 class="glitch-text text-hero font-mono font-bold text-accent leading-none tracking-tighter" data-text="MPD">
        MPD
      </h1>
      <span class="block text-sm font-mono text-muted tracking-wide mt-3 opacity-70">
        Matthew Peck-Deloughry
      </span>
    </a>

    <!-- Navigation -->
    <nav
      id="navigation-menu"
      class="absolute -inset-x-4 top-full hidden flex-col gap-0 bg-bgColor border border-white/10 p-4 group-[.menu-open]:z-50 group-[.menu-open]:flex md:static md:flex md:flex-row md:items-center md:gap-6 md:border-0 md:bg-transparent md:p-0"
      aria-label="Main menu"
    >
      {menuLinks.map((link) => (
        <a
          href={link.path}
          class="nav-link py-2 font-mono text-sm text-muted transition-colors hover:text-textColor"
          aria-current={url.pathname === link.path ? "page" : false}
          rel="prefetch"
        >
          {link.title}
        </a>
      ))}
    </nav>
  </div>

  <!-- Mobile menu button -->
  <button
    id="toggle-navigation-menu"
    class="group/btn absolute right-4 top-8 h-10 w-10 border border-white/20 rounded bg-transparent md:hidden"
    type="button"
    aria-label="Open main menu"
    aria-expanded="false"
    aria-haspopup="menu"
  >
    <!-- Hamburger icon -->
    <svg
      class="absolute left-1/2 top-1/2 h-5 w-5 -translate-x-1/2 -translate-y-1/2 text-textColor transition-all group-aria-expanded/btn:scale-0 group-aria-expanded/btn:opacity-0"
      aria-hidden="true"
      xmlns="http://www.w3.org/2000/svg"
      fill="none"
      viewBox="0 0 24 24"
      stroke-width="1.5"
      stroke="currentColor"
    >
      <path stroke-linecap="round" d="M4 6h16M4 12h16M4 18h16"></path>
    </svg>
    <!-- Close icon -->
    <svg
      class="absolute left-1/2 top-1/2 h-5 w-5 -translate-x-1/2 -translate-y-1/2 scale-0 text-textColor opacity-0 transition-all group-aria-expanded/btn:scale-100 group-aria-expanded/btn:opacity-100"
      aria-hidden="true"
      xmlns="http://www.w3.org/2000/svg"
      fill="none"
      viewBox="0 0 24 24"
      stroke-width="1.5"
      stroke="currentColor"
    >
      <path stroke-linecap="round" d="M6 18L18 6M6 6l12 12"></path>
    </svg>
  </button>
</header>

<style>
  .nav-link {
    position: relative;
  }

  .nav-link[aria-current="page"] {
    color: var(--theme-text);
  }

  .nav-link[aria-current="page"]::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 1px;
    background: var(--theme-accent);
  }
</style>
